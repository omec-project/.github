# SPDX-FileCopyrightText: 2026 Intel Corporation
# Copyright 2025 Canonical Ltd.
# SPDX-License-Identifier: Apache-2.0
name: Clang-format check

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Name of the branch to checkout"
        required: false
        type: string
        default: ${{ github.ref }}
      clang_format_version:
        description: "The major version of clang-format that you want to run the check on"
        required: false
        type: string
        default: "14"
      check_path:
        description: |
          The path to the directory in the repo that should be checked for C/C++/Protobuf formatting.
          If multiple paths need to be checked, a matrix run is required.
        required: false
        type: string
        default: "."
      exclude_regex:
        description: "A regular expression (standard POSIX extended regex) to exclude files or directories that should not be checked."
        required: false
        type: string
        default: "^$"

jobs:
  check-clang-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.branch_name }}

      - name: Install clang-format
        run: |
          sudo apt-get update
          if ! sudo apt-get install -y clang-format-${{ inputs.clang_format_version }}; then
            echo "Error: Failed to install clang-format-${{ inputs.clang_format_version }}."
            echo "The requested clang-format version may not be available on ubuntu-latest."
            echo "Please select a clang_format_version that is supported by the runner image."
            exit 1
          fi
          if [ ! -x "/usr/bin/clang-format-${{ inputs.clang_format_version }}" ]; then
            echo "Error: clang-format-${{ inputs.clang_format_version }} package installed, but"
            echo "the binary /usr/bin/clang-format-${{ inputs.clang_format_version }} is not present or not executable."
            exit 1
          fi
          sudo ln -sf /usr/bin/clang-format-${{ inputs.clang_format_version }} /usr/bin/clang-format

      - name: Run clang-format check
        id: format-check
        continue-on-error: true
        run: |
          CHECK_PATH="${{ inputs.check_path }}"
          EXCLUDE_REGEX="${{ inputs.exclude_regex }}"

          # Set default regex if empty
          if [[ -z "$EXCLUDE_REGEX" ]]; then
            EXCLUDE_REGEX="^$"
          fi

          # Find all C/C++/Protobuf files
          INCLUDE_REGEX='^.*\.((((c|C)(c|pp|xx|\+\+)?$)|((h|H)h?(pp|xx|\+\+)?$))|(ino|pde|proto|cu))$'

          # File to collect failed files
          FAILED_FILES_LIST="${{ runner.temp }}/failed_files.txt"
          > "$FAILED_FILES_LIST"
          
          # Find files and check formatting
          HAS_FAILURES=0
          while IFS= read -r file; do
            if ! [[ "$file" =~ $EXCLUDE_REGEX ]]; then
              if ! clang-format --dry-run --Werror --style=file --fallback-style=llvm "$file" 2>&1; then
                echo "Failed on file: $file"
                echo "$file" >> "$FAILED_FILES_LIST"
                HAS_FAILURES=1
              fi
            fi
          done < <(find "$CHECK_PATH" -name .git -prune -o -regextype posix-egrep -regex "$INCLUDE_REGEX" -print)

          # Save results for summary step
          echo "has_failures=$HAS_FAILURES" >> $GITHUB_OUTPUT
          echo "failed_files_list=$FAILED_FILES_LIST" >> $GITHUB_OUTPUT
          echo "check_path=$CHECK_PATH" >> $GITHUB_OUTPUT
          echo "include_regex=$INCLUDE_REGEX" >> $GITHUB_OUTPUT
          
          exit $HAS_FAILURES

      - name: Print formatting summary
        if: always() && steps.format-check.outputs.has_failures == '1'
        run: |
          FAILED_FILES_LIST="${{ steps.format-check.outputs.failed_files_list }}"
          CHECK_PATH="${{ steps.format-check.outputs.check_path }}"
          INCLUDE_REGEX="${{ steps.format-check.outputs.include_regex }}"
          
          FAILED_COUNT=$(wc -l < "$FAILED_FILES_LIST")
          
          echo ""
          echo "=========================================="
          echo "Clang-format check failed for $FAILED_COUNT file(s):"
          echo "=========================================="
          while IFS= read -r file; do
            echo "  - $file"
          done < "$FAILED_FILES_LIST"
          echo "=========================================="
          echo ""
          echo "To fix formatting issues, run:"
          echo "  clang-format -i <file>"
          echo "Or to format all files:"
          echo "  find ${CHECK_PATH} -regextype posix-egrep -regex '${INCLUDE_REGEX}' -exec clang-format -i {} +"
          
          exit 1

      - name: Confirm formatting success
        if: steps.format-check.outputs.has_failures != '1'
        run: |
          echo "âœ“ All files passed clang-format check!"
