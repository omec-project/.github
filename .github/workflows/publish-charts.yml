# Copyright 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
name: Publish Helm Charts

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Name of the branch to checkout"
        required: false
        type: string
        default: ${{ github.ref }}
      registry:
        description: "Container registry URL"
        required: false
        type: string
        default: "ghcr.io"

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'omec-project'
    env:
      CHARTS_DIR: charts
      UMBRELLA_CHARTS: ./sdcore-helm-charts
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.branch_name }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Find and package individual charts
        run: |
          rm -rf ${{ env.CHARTS_DIR }} && mkdir -p ${{ env.CHARTS_DIR }}

          for dir in $(find . -maxdepth 1 -mindepth 1 -type d); do
            if [[ -f "$dir/Chart.yaml" ]] && [[ "$dir" != "${{ env.UMBRELLA_CHARTS }}" ]]; then
              echo "Processing chart: $dir"
              helm dependency update "$dir"
              helm package "$dir" --destination ${{ env.CHARTS_DIR }}
              CHART_NAME=$(helm show chart "$dir" | grep '^name:' | awk '{print $2}')
              CHART_VERSION=$(helm show chart "$dir" | grep '^version:' | awk '{print $2}')
              echo "Publishing $CHART_NAME:$CHART_VERSION to OCI registry"
              helm push "${{ env.CHARTS_DIR }}/${CHART_NAME}-${CHART_VERSION}.tgz" \
                oci://${{ inputs.registry }}/${{ github.repository_owner }}
            fi
          done

      - name: Package and publish umbrella chart
        if: hashFiles('./sdcore-helm-charts/Chart.yaml') != ''
        run: |
          echo "Processing umbrella chart: ${{ env.UMBRELLA_CHARTS }}"
          helm dependency update "${{ env.UMBRELLA_CHARTS }}"
          helm package "${{ env.UMBRELLA_CHARTS }}" --destination ${{ env.CHARTS_DIR }}
          CHART_NAME=$(helm show chart "${{ env.UMBRELLA_CHARTS }}" | grep '^name:' | awk '{print $2}')
          CHART_VERSION=$(helm show chart "${{ env.UMBRELLA_CHARTS }}" | grep '^version:' | awk '{print $2}')
          echo "Publishing umbrella chart $CHART_NAME:$CHART_VERSION to OCI registry"
          helm push "${{ env.CHARTS_DIR }}/${CHART_NAME}-${CHART_VERSION}.tgz" \
            oci://${{ inputs.registry }}/${{ github.repository_owner }}

      - name: List published charts
        run: |
          echo "Charts published to ${{ inputs.registry }}/${{ github.repository_owner }}:"
          ls -la ${{ env.CHARTS_DIR }}/*.tgz 2>/dev/null || echo "No chart packages found"
