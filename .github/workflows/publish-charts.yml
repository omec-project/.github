# Copyright 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
name: Publish Helm Charts

on:
  workflow_call:
    inputs:
      branch_name:
        description: "Name of the branch to checkout"
        required: false
        type: string
        default: ${{ github.ref }}
      registry:
        description: "Container registry URL"
        required: false
        type: string
        default: "ghcr.io"

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'omec-project'
    env:
      CHARTS_DIR: charts
      UMBRELLA_CHARTS: ./sdcore-helm-charts
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.branch_name }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Find, package and publish all charts
        run: |
          # Create unique temporary directory
          TEMP_DIR=$(mktemp -d -t helm-charts-XXXXXX)
          echo "ðŸ“ Created temporary directory: $TEMP_DIR"

          # Set up cleanup trap
          cleanup() {
            if [ -n "$TEMP_DIR" ] && [ -d "$TEMP_DIR" ]; then
              echo "ðŸ§¹ Cleaning up temporary directory: $TEMP_DIR"
              rm -rf "$TEMP_DIR"
            fi
          }
          trap cleanup EXIT INT TERM

          rm -rf ${{ env.CHARTS_DIR }} && mkdir -p ${{ env.CHARTS_DIR }}

          # Initialize counters explicitly
          SUCCESS_COUNT=0
          SKIPPED_COUNT=0
          FAILURE_COUNT=0

          # Function to check if chart version exists
          check_chart_exists() {
            local chart_name="$1"
            local chart_version="$2"
            local registry_url="oci://${{ inputs.registry }}/${{ github.repository_owner }}"

            echo "ðŸ” Checking if $chart_name:$chart_version exists..."

            # Try to pull the chart to our shared temp directory
            if helm pull "$registry_url/$chart_name" --version "$chart_version" --destination "$TEMP_DIR" >/dev/null 2>&1; then
              echo "ðŸ“¦ Chart $chart_name:$chart_version already exists"
              # Clean up the downloaded file
              rm -f "$TEMP_DIR/$chart_name-$chart_version.tgz" 2>/dev/null || true
              return 0  # exists
            else
              echo "âœ¨ Chart $chart_name:$chart_version does not exist, will publish"
              return 1  # does not exist
            fi
          }

          # Function to process a chart (individual or umbrella)
          process_chart() {
            local chart_dir="$1"
            local chart_type="$2"  # "individual" or "umbrella"

            echo "ðŸ”„ Processing $chart_type chart: $chart_dir"

            # Execute helm show chart once and store the output
            CHART_INFO=$(helm show chart "$chart_dir")
            if [ $? -ne 0 ] || [ -z "$CHART_INFO" ]; then
              echo "âŒ Failed to read chart information from $chart_dir"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
              return 1
            fi

            # Extract chart name and version from the stored output
            CHART_NAME=$(echo "$CHART_INFO" | grep '^name:' | awk '{print $2}' | tr -d '\r')
            CHART_VERSION=$(echo "$CHART_INFO" | grep '^version:' | awk '{print $2}' | tr -d '\r')

            if [ -z "$CHART_NAME" ] || [ -z "$CHART_VERSION" ]; then
              echo "âŒ Could not extract chart name or version from $chart_dir"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
              return 1
            fi

            # Check if chart already exists
            if check_chart_exists "$CHART_NAME" "$CHART_VERSION"; then
              echo "â­ï¸  Skipping $chart_type chart $CHART_NAME:$CHART_VERSION (already exists)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              return 0
            fi

            # Update dependencies
            if ! helm dependency update "$chart_dir"; then
              echo "âŒ Failed to update dependencies for $chart_dir"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
              return 1
            fi

            # Package chart
            if ! helm package "$chart_dir" --destination ${{ env.CHARTS_DIR }}; then
              echo "âŒ Failed to package chart $chart_dir"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
              return 1
            fi

            echo "ðŸ“¦ Publishing $chart_type chart $CHART_NAME:$CHART_VERSION to OCI registry"

            # Push chart
            if helm push "${{ env.CHARTS_DIR }}/${CHART_NAME}-${CHART_VERSION}.tgz" \
              "oci://${{ inputs.registry }}/${{ github.repository_owner }}"; then
              echo "âœ… Successfully pushed $chart_type chart $CHART_NAME:$CHART_VERSION"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              return 0
            else
              echo "âŒ Failed to push $chart_type chart $CHART_NAME:$CHART_VERSION"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
              return 1
            fi
          }

          # Process individual charts
          echo "ðŸš€ Starting individual charts processing..."
          for dir in $(find . -maxdepth 1 -mindepth 1 -type d); do
            if [[ -f "$dir/Chart.yaml" ]] && [[ "$dir" != "${{ env.UMBRELLA_CHARTS }}" ]]; then
              process_chart "$dir" "individual"
            fi
          done

          # Process umbrella chart
          echo ""
          echo "ðŸš€ Starting umbrella chart processing..."
          if [[ -f "${{ env.UMBRELLA_CHARTS }}/Chart.yaml" ]]; then
            process_chart "${{ env.UMBRELLA_CHARTS }}" "umbrella"
          else
            echo "â„¹ï¸  No umbrella chart found at ${{ env.UMBRELLA_CHARTS }}"
          fi

          echo ""
          echo "ðŸ“Š Final Summary:"
          echo "  âœ… Successfully published: $SUCCESS_COUNT"
          echo "  â­ï¸  Skipped (already exists): $SKIPPED_COUNT"
          echo "  âŒ Failed: $FAILURE_COUNT"
          echo "  ðŸ“ˆ Total processed: $((SUCCESS_COUNT + SKIPPED_COUNT + FAILURE_COUNT))"

          # Only fail if there were actual failures (not skips)
          if [ "$FAILURE_COUNT" -gt 0 ]; then
            echo "âŒ Workflow failed due to $FAILURE_COUNT chart(s) failing to publish"
            exit 1
          else
            echo "ðŸŽ‰ All charts processed successfully!"
          fi

      - name: List published charts
        if: always()
        run: |
          echo "ðŸ“‹ Charts in build directory:"
          if ls ${{ env.CHARTS_DIR }}/*.tgz >/dev/null 2>&1; then
            ls -la ${{ env.CHARTS_DIR }}/*.tgz
          else
            echo "No chart packages found in build directory"
          fi
